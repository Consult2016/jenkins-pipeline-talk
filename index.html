<!doctype html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

		<title>Denver Jenkins Area Meetup</title>

		<link rel="stylesheet" href="css/reveal.css">
		<link rel="stylesheet" href="css/theme/white.css">

		<!-- Theme used for syntax highlighting of code -->
		<link rel="stylesheet" href="lib/css/zenburn.css">

		<!-- Printing and PDF exports -->
		<script>
			var link = document.createElement( 'link' );
			link.rel = 'stylesheet';
			link.type = 'text/css';
			link.href = window.location.search.match( /print-pdf/gi ) ? 'css/print/pdf.css' : 'css/print/paper.css';
			document.getElementsByTagName( 'head' )[0].appendChild( link );
		</script>
	</head>
	<body>
		<div class="reveal">
			<div class="slides">
				<section>
					<h2>Jenkins 2 Pipeline as a Code</h2>
					<h6>Denver Jenkins Area Meetup</h6>
					<a href="https://jenkins.io" target="_blank">
						<img data-src="images/logo.png" alt="Jenkins Logo" style="border: none;">
					</a>
				</section>

				<section>
					<h2>Mayank Patel</h2>
					<h4>Application Architect @ <a href="https://www.oildex.com" target="_blank">Oildex</a></h4>
					<p>
						<small>
							<a href="https://www.linkedin.com/in/mayank-patel-b9141210/" target="_blank">Linkedin</a> /
							<a href="https://twitter.com/maxy_ermayank" target="_blank">@maxy_ermayank</a> /
							<a href="https://medium.com/@maxy_ermayank" target="_blank">Medium</a>
						</small>
					</p>
				</section>

				<section>
					<h2><a href="https://www.oildex.com" target="_blank">Oildex</a></h2>
					<h5>Software as a Service Provider for Oil and Gas companies</h5>
					<ul><li>7.5 Years</li></ul>
				</section>

				<section>
					<h2>Focused on</h2>
					<ul>
						<li>Streaming, Reactive, Non-blocking Architecture</li>
						<li>API Design</li>
						<li>DevOps</li>
						<li>Cloud Native Architecture</li>
						<li>Empowering software development teams</li>
						<li>Digital Transformation and Digital Optimization</li>
					</ul>
				</section>

				<section>
					<h2>Agenda</h2>
					<ul>
						<li>Overview of Jenkins 2</li>
						<li>Jenkins Pipeline Features</li>
						<li>Jenkins Environment</li>
						<li>Ideal Pipeline Flow</li>
						<li>Important pipeline plugins</li>
						<li>
							Demo
							<ul>
								<li>Setup and configure a pipeline</li>
								<li>Using Docker with pipelines</li>
							</ul>
						</li>
					</ul>
				</section>

				<section>
					<h2>Overview of Jenkins 2</h2>
					<ul>
						<li>Built-in support for delivery pipelines.</li>
						<li>Improved usability.</li>
						<li>Fully backwards compatible.</li>
					</ul>
				</section>

				<section data-transition="slide" data-background="#4d7e65" data-background-transition="zoom">
					<section data-transition="slide" data-background="#4d7e65" data-background-transition="zoom">
						<h2>Jenkins Pipeline Features</h2>
					</section>
					<section data-transition="slide" data-background="#4d7e65" data-background-transition="zoom">
						<p>Can support complex, real-world, CD Pipeline requirements: pipelines can fork/join, loop, parallel, to name a few programmatically</p>
					</section>
					<section data-transition="slide" data-background="#4d7e65" data-background-transition="zoom">
						<p>Is Resilient: pipeline executions can survive master restarts</p>
					</section>
					<section data-transition="slide" data-background="#4d7e65" data-background-transition="zoom">
						<p>Is Pausable: pipelines can pause and wait for human input/approval</p>
					</section>
					<section data-transition="slide" data-background="#4d7e65" data-background-transition="zoom">
						<p>Is Efficient: pipelines can restart from saved checkpoints</p>
					</section>
					<section data-transition="slide" data-background="#4d7e65" data-background-transition="zoom">
						<p>Is Visualized: Pipeline StageView provides status at-a-glance dashboards including trending</p>
					</section>
					<section data-transition="slide" data-background="#4d7e65" data-background-transition="zoom">
						<p>Pipeline configuration as a code in source control</p>
					</section>
					<section data-transition="slide" data-background="#4d7e65" data-background-transition="zoom">
						<p>Ability to embed Security part of DevOps pipeline</p>
					</section>
					<section data-transition="slide" data-background="#4d7e65" data-background-transition="zoom">
						<p>Reusability</p>
					</section>
					<section data-transition="slide" data-background="#4d7e65" data-background-transition="zoom">
						<p>Easy Recoverability</p>
					</section>
				</section>
				
				<!-- <section data-transition="slide" data-background="#4d7e65" data-background-transition="zoom">
					<section data-transition="slide" data-background="#4d7e65" data-background-transition="zoom">
						<h2>Jenkins Pipeline Features</h2>
						<ul>
							<li>Can support complex, real-world, CD Pipeline requirements: pipelines can fork/join, loop, parallel, to name a few programmatically</li>
							<li>Is Resilient: pipeline executions can survive master restarts</li>
							<li>Is Pausable: pipelines can pause and wait for human input/approval</li>
							<li>Is Efficient: pipelines can restart from saved checkpoints</li>
						</ul>
					</section>

					<section data-transition="slide" data-background="#4d7e65" data-background-transition="zoom">
						<h2>Jenkins Pipeline Features (Cont.)</h2>
						<ul>
							<li>Is Visualized: Pipeline StageView provides status at-a-glance dashboards including trending</li>
							<li>Pipeline configuration as a code in source control</li>
							<li>Ability to embed Security part of DevOps pipeline</li>
							<li>Reusability</li>
							<li>Easy Recoverability</li>
						</ul>
					</section>
				</section> -->
				
				<section>
					<h2>Jenkins Environment</h2>
					<a href="images/JenkinsEnvironment.png" target="_blank">
						<img data-src="images/JenkinsEnvironment.png" alt="Jenkins Environment" style="width: 100%; height: 100%;">
					</a>
				</section>

				<section>
					<h2>Pipeline Flow</h2>
					<a href="images/JenkinsPipeline.png" target="_blank">
						<img data-src="images/JenkinsPipeline.png" alt="Jenkins Pipeline" style="width: 100%; height: 100%;">
					</a>
				</section>

				<section>
					<h2>Important pipeline plugins</h2>
					<ul>
						<li><a href="https://plugins.jenkins.io/workflow-aggregator" target="_blank">Pipeline Plugin</a></li>
						<li><a href="https://plugins.jenkins.io/docker-workflow" target="_blank">Docker Pipeline</a></li>
						<li><a href="https://plugins.jenkins.io/docker-plugin" target="_blank">Docker</a></li>
						<li><a href="https://plugins.jenkins.io/pipeline-stage-view" target="_blank">Pipeline Stage View</a></li>
						<li><a href="https://plugins.jenkins.io/github" target="_blank">GitHub</a></li>
						<li><a href="https://plugins.jenkins.io/blueocean" target="_blank">Blue Ocean</a></li>
						<li><a href="#" target="_blank">Many More...</a></li>
					</ul>
				</section>

				<section><a href="https://jenkins.io/blog/2018/06/15/simple-pull-request-plugin/" target="_blank">GSoC Project Intro: Pipeline as YAML</a></section>

				<section data-transition="slide" data-background="#4d7e65" data-background-transition="zoom">
					<h2>Demo</h2>
				</section>
	
				<section>
					<h2>Jenkins Pipeline Sample</h2>
					<pre>
						<code class="hljs" data-trim>
								#!groovy

								pipeline {
								
									agent {
										docker {
										image 'jenkinsslave:latest'
										registryUrl 'http://8598567586.dkr.ecr.us-west-2.amazonaws.com'
										registryCredentialsId 'ecr:us-east-1:5348753459435-244656-34445-4545'
										args '-v /home/centos/.ivy2:/home/jenkins/.ivy2:rw -v jenkins_opt:/usr/local/bin/opt -v jenkins_apijenkins:/home/jenkins/config -v jenkins_logs:/var/logs -v jenkins_awsconfig:/home/jenkins/.aws --privileged=true -u jenkins:jenkins'
										}
									}
									environment {
										APP_NAME = 'billing-rest'
										BUILD_NUMBER = "${env.BUILD_NUMBER}"
										IMAGE_VERSION="v_${BUILD_NUMBER}"
										GIT_URL="git@github.yourdomain.com:mpatel/${APP_NAME}.git"
										GIT_CRED_ID='fg4545454-18b6-4cd8-93ad-c456bfh5655e7fc'
										REPOURL = '8598567586.dkr.ecr.us-west-2.amazonaws.com'
										SBT_OPTS='-Xmx1024m -Xms512m'
										JAVA_OPTS='-Xmx1024m -Xms512m'
										WS_PRODUCT_TOKEN='e2fb83cd-f47f-496a-ae27-84ddd1e94df8'
										WS_PROJECT_TOKEN='d4a8f42d55f94a50850b7c2dd5d6ea36b8d8dd10bfab450b9827662f39245c2a'
										HIPCHAT_TOKEN = 'b454dfvdfg56c95465656722c9656576fgn563b0'
										HIPCHAT_ROOM = 'Bots'
									}
								
									options {
										buildDiscarder(logRotator(artifactDaysToKeepStr: '', artifactNumToKeepStr: '', daysToKeepStr: '10', numToKeepStr: '20'))
										timestamps()
										//retry(3)
										timeout time:10, unit:'MINUTES'
									}
									parameters {
										string(defaultValue: "develop", description: 'Branch Specifier', name: 'SPECIFIER')
										booleanParam(defaultValue: false, description: 'Deploy to QA Environment ?', name: 'DEPLOY_QA')
										booleanParam(defaultValue: false, description: 'Deploy to UAT Environment ?', name: 'DEPLOY_UAT')
										booleanParam(defaultValue: false, description: 'Deploy to PROD Environment ?', name: 'DEPLOY_PROD')
									}
								
									stages {
										stage("Initialize") {
											steps {
												script {
													notifyBuild('STARTED')
													echo "${BUILD_NUMBER} - ${env.BUILD_ID} on ${env.JENKINS_URL}"
													echo "Branch Specifier :: ${params.SPECIFIER}"
													echo "Deploy to QA? :: ${params.DEPLOY_QA}"
													echo "Deploy to UAT? :: ${params.DEPLOY_UAT}"
													echo "Deploy to PROD? :: ${params.DEPLOY_PROD}"
													sh 'rm -rf target/universal/*.zip'
												}
											}
										}
										stage('Checkout') {
											steps {
												echo 'Checkout Repo'
												git branch: "${params.SPECIFIER}", url: "${GIT_URL}"
											}
										}
										stage('Build') {
											steps {
												echo 'Run coverage and CLEAN UP Before please'
								//                sh './sbt -Dsbt.global.base=.sbt -Dsbt.ivy.home=/home/jenkins/.ivy2 -Divy.home=/home/jenkins/.ivy2 compile coverage test coverageReport coverageOff dist'
												sh '/usr/local/bin/opt/bin/sbtGitActivator; /usr/local/bin/opt/play-2.5.10/bin/activator -Dsbt.global.base=.sbt -Dsbt.ivy.home=/home/jenkins/.ivy2 -Divy.home=/home/jenkins/.ivy2 compile coverage test coverageReport coverageOff dist'
											}
										}
										stage('Publish Reports') {
											steps {
													echo 'Publish Junit Report'
													junit allowEmptyResults: true, testResults: 'target/test-reports/*.xml'
								
												step([$class: 'FindBugsPublisher', canComputeNew: false, defaultEncoding: '', excludePattern: '', healthy: '', includePattern: '', pattern: 'target/scala-2.11/findbugs/report.xml', unHealthy: ''])
								
													echo 'Publish Junit HTML Report'
													publishHTML target: [
														allowMissing: true,
														alwaysLinkToLastBuild: false,
														keepAll: true,
														reportDir: 'target/reports/html',
														reportFiles: 'index.html',
														reportName: 'Test Suite HTML Report'
													]
								
													echo 'Publish Coverage HTML Report'
													publishHTML target: [
														allowMissing: true,
														alwaysLinkToLastBuild: false,
														keepAll: true,
														reportDir: 'target/scala-2.11/scoverage-report',
														reportFiles: 'index.html',
														reportName: 'Code Coverage'
													]
								
												whitesource jobApiToken: '', jobCheckPolicies: 'global', jobForceUpdate: 'global', libExcludes: '', libIncludes: '', product: "${env.WS_PRODUCT_TOKEN}", productVersion: '', projectToken: "${env.WS_PROJECT_TOKEN}", requesterEmail: ''
											}
										}
										stage('SonarQube analysis') {
											steps {
												sh "/usr/bin/sonar-scanner"
											}
										}
										stage('ArchiveArtifact') {
											steps {
												echo 'Archive Artifact'
												archiveArtifacts '**/target/universal/*.zip'
											}
										}
								
											stage('Docker Tag &amp; Push') {
												steps {
													script {
														branchName = getCurrentBranch()
														shortCommitHash = getShortCommitHash()
														IMAGE_VERSION = "${BUILD_NUMBER}-" + branchName + "-" + shortCommitHash
														sh 'eval $(aws ecr get-login --no-include-email --region us-west-2)'
														sh "docker-compose build"
														sh "docker tag ${REPOURL}/${APP_NAME}:latest ${REPOURL}/${APP_NAME}:${IMAGE_VERSION}"
														sh "docker push ${REPOURL}/${APP_NAME}:${IMAGE_VERSION}"
														sh "docker push ${REPOURL}/${APP_NAME}:latest"
								
														sh "docker rmi ${REPOURL}/${APP_NAME}:${IMAGE_VERSION} ${REPOURL}/${APP_NAME}:latest"
													}
												}
											}
								
										stage('Deploy - CI') {
											steps {
												echo "Deploying to CI Environment."
											}
										}
								
										stage('Deploy - QA') {
											when {
												expression {
													params.DEPLOY_QA == true
												}
											}
											steps {
												echo "Deploy to QA..."
											}
										}
										stage('Deploy - UAT') {
											when {
												expression {
													params.DEPLOY_UAT == true
												}
											}
											steps {
												echo "Deploy to UAT..."
											}
										}
										stage('Deploy - Production') {
											when {
												expression {
													params.DEPLOY_PROD == true
												}
											}
											steps {
												echo "Deploy to PROD..."
											}
										}
									}
								
									post {
										/*
											* These steps will run at the end of the pipeline based on the condition.
											* Post conditions run in order regardless of their place in pipeline
											* 1. always - always run
											* 2. changed - run if something changed from last run
											* 3. aborted, success, unstable or failure - depending on status
											*/
										always {
											echo "I AM ALWAYS first"
											notifyBuild("${currentBuild.currentResult}")
										}
										aborted {
											echo "BUILD ABORTED"
										}
										success {
											echo "BUILD SUCCESS"
											echo "Keep Current Build If branch is master"
								//            keepThisBuild()
										}
										unstable {
											echo "BUILD UNSTABLE"
										}
										failure {
											echo "BUILD FAILURE"
										}
									}
								}
								
								def keepThisBuild() {
									currentBuild.setKeepLog(true)
									currentBuild.setDescription("Test Description")
								}
								
								def getShortCommitHash() {
									return sh(returnStdout: true, script: "git log -n 1 --pretty=format:'%h'").trim()
								}
								
								def getChangeAuthorName() {
									return sh(returnStdout: true, script: "git show -s --pretty=%an").trim()
								}
								
								def getChangeAuthorEmail() {
									return sh(returnStdout: true, script: "git show -s --pretty=%ae").trim()
								}
								
								def getChangeSet() {
									return sh(returnStdout: true, script: 'git diff-tree --no-commit-id --name-status -r HEAD').trim()
								}
								
								def getChangeLog() {
									return sh(returnStdout: true, script: "git log --date=short --pretty=format:'%ad %aN <%ae> %n%n%x09* %s%d%n%b'").trim()
								}
								
								def getCurrentBranch () {
									return sh (
											script: 'git rev-parse --abbrev-ref HEAD',
											returnStdout: true
									).trim()
								}
								
								def isPRMergeBuild() {
									return (env.BRANCH_NAME ==~ /^PR-\d+$/)
								}
								
								def notifyBuild(String buildStatus = 'STARTED') {
									// build status of null means successful
									buildStatus = buildStatus ?: 'SUCCESS'
								
									def branchName = getCurrentBranch()
									def shortCommitHash = getShortCommitHash()
									def changeAuthorName = getChangeAuthorName()
									def changeAuthorEmail = getChangeAuthorEmail()
									def changeSet = getChangeSet()
									def changeLog = getChangeLog()
								
									// Default values
									def colorName = 'RED'
									def colorCode = '#FF0000'
									def subject = "${buildStatus}: '${env.JOB_NAME} [${env.BUILD_NUMBER}]'" + branchName + ", " + shortCommitHash
									def summary = "Started: Name:: ${env.JOB_NAME} \n " +
											"Build Number: ${env.BUILD_NUMBER} \n " +
											"Build URL: ${env.BUILD_URL} \n " +
											"Short Commit Hash: " + shortCommitHash + " \n " +
											"Branch Name: " + branchName + " \n " +
											"Change Author: " + changeAuthorName + " \n " +
											"Change Author Email: " + changeAuthorEmail + " \n " +
											"Change Set: " + changeSet
								
									if (buildStatus == 'STARTED') {
										color = 'YELLOW'
										colorCode = '#FFFF00'
									} else if (buildStatus == 'SUCCESS') {
										color = 'GREEN'
										colorCode = '#00FF00'
									} else {
										color = 'RED'
										colorCode = '#FF0000'
									}
								
									// Send notifications
									hipchatSend(color: color, notify: true, message: summary, token: "${env.HIPCHAT_TOKEN}",
										failOnError: true, room: "${env.HIPCHAT_ROOM}", sendAs: 'Jenkins', textFormat: true)
								
									if (buildStatus == 'FAILURE') {
										emailext attachLog: true, body: summary, compressLog: true, recipientProviders: [brokenTestsSuspects(), brokenBuildSuspects(), culprits()], replyTo: 'noreply@yourdomain.com', subject: subject, to: 'mpatel@yourdomain.com'
									}
								}

						</code>
					</pre>
				</section>

				<section>
					<h2>Classic Pipeline Stage View</h2>
					<a href="images/ClassicPipelineStageView.png" target="_blank">
						<img data-src="images/ClassicPipelineStageView.png" alt="Classic Pipeline Stage View" style="width: 100%; height: 100%;">
					</a>
				</section>

				<section>
					<h2>Blue Ocean Pipeline Stage View</h2>
					<a href="images/BlueOceanPipelineStageView.png" target="_blank">
						<img data-src="images/BlueOceanPipelineStageView.png" alt="Blue Ocean Pipeline Stage View" style="width: 100%; height: 100%;">
					</a>
				</section>

				<section>
					<h2>Resources</h2>
					<ul>
						<li><a href="https://jenkins.io/blog/2017/02/01/pipeline-scalability-best-practice/#best-practices-for-scalable-pipeline-code" target="_blank">Best Practices for Scalable Pipeline Code</a></li>
						<li><a href="https://trends.google.com/trends/explore?date=today%201-m&amp;q=%2Fm%2F0g9x0gr,%2Fm%2F0jwwmpp,%2Fg%2F11byt8jwgw,%2Fm%2F0125_4f0" target="_blank">Google Trends</a></li>
						<li><a href="https://github.com/jenkinsci/pipeline-plugin/blob/master/COMPATIBILITY.md" target="_blank">Plugin Compatibility with Pipeline</a></li>
						<li><a href="https://github.com/jenkinsci/pipeline-examples" target="_blank">Pipeline Example Repository</a></li>
						<li><a href="https://github.com/maxyermayank/jenkins-pipeline-talk" target="_blank">jenkins-pipeline-talk</a></li>
						<li><a href="https://github.com/maxyermayank/jenkins-pipeline-demo" target="_blank">jenkins-pipeline-demo</a></li>
						<li><a href="https://plugins.jenkins.io/" target="_blank">Jenkins Plugins</a></li>
						<li><a href="https://www.cloudbees.com/blog/top-10-best-practices-jenkins-pipeline-plugin" target="_blank">Top 10 Best Practices for Jenkins Pipeline Plugin</a></li>
					</ul>
				</section>

				<section style="text-align: left;">
					<h1>Thank You!</h1>
					<h3>Questions?</h3>
				</section>
			</div>
		</div>

		<script src="lib/js/head.min.js"></script>
		<script src="js/reveal.js"></script>

		<script>
			// More info about config & dependencies:
			// - https://github.com/hakimel/reveal.js#configuration
			// - https://github.com/hakimel/reveal.js#dependencies
			Reveal.initialize({
				dependencies: [
					{ src: 'plugin/markdown/marked.js' },
					{ src: 'plugin/markdown/markdown.js' },
					{ src: 'plugin/notes/notes.js', async: true },
					{ src: 'plugin/highlight/highlight.js', async: true, callback: function() { hljs.initHighlightingOnLoad(); } }
				]
			});
		</script>
	</body>
</html>
